# ============================================
# URL REWRITING & REDIRECTS
# ============================================
<IfModule mod_rewrite.c>
  RewriteEngine On
  
  # Force HTTPS and non-www (or www - choose one and be consistent)
  RewriteCond %{HTTPS} off [OR]
  RewriteCond %{HTTP_HOST} ^balakarthikeyan.me [NC,OR]
  RewriteCond %{HTTP_HOST} ^www\.balakarthikeyan\.me$ [NC]
  RewriteRule ^(.*)$ https://www.balakarthikeyan.me/$1 [L,R=301,NE]
  
  # Remove trailing slashes (except for directories)
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteCond %{THE_REQUEST} \s/+(.+?)/+[?\s]
  RewriteRule ^(.+?)/$ /$1 [R=301,L]
  
  # Remove index.php from URLs
  RewriteCond %{THE_REQUEST} ^[A-Z]{3,}\s(.*)/index\.php(\?|\s|$) [NC]
  RewriteRule ^ %1 [R=301,L]
  
  # Handle React Router - SPA Fallback
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteCond %{REQUEST_URI} !\.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot|map)$ [NC]
  RewriteRule . /index.html [L]
  
  # Redirect old URLs to new URLs (example)
  # RewriteRule ^old-path/(.*)$ /new-path/$1 [R=301,L,NC]
  
  # Prevent directory listing
  Options -Indexes
  
  # Block access to hidden files and directories
  RewriteCond %{SCRIPT_FILENAME} -d [OR]
  RewriteCond %{SCRIPT_FILENAME} -f
  RewriteRule "(^|/)\." - [F]
  
  # Block access to backup and source files
  <FilesMatch "(\.(bak|config|dist|fla|inc|ini|log|psd|sh|sql|sw[op])|~|\#)$">
    Order allow,deny
    Deny from all
    Satisfy All
  </FilesMatch>
</IfModule>

# ============================================
# SECURITY HEADERS
# ============================================
<IfModule mod_headers.c>
  # Protect against XSS attacks
  Header set X-XSS-Protection "1; mode=block"
  Header set X-Content-Type-Options "nosniff"
  Header set X-Frame-Options "SAMEORIGIN"
  Header set Referrer-Policy "strict-origin-when-cross-origin"
  Header set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
  
  # Enable HSTS (uncomment after testing)
  Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
  
  # Content Security Policy (update with your specific requirements)
  <IfModule mod_headers.c>
    Header set Content-Security-Policy \
      "default-src 'self'; \
      script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.google-analytics.com https://www.googletagmanager.com; \
      style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; \
      img-src 'self' data: https:; \
      font-src 'self' https://fonts.gstatic.com; \
      connect-src 'self' https://www.google-analytics.com https://region1.google-analytics.com; \
      frame-src 'self' https://www.youtube.com https://www.google.com; \
      media-src 'self' https:; \
      object-src 'none';"
  </IfModule>
  
  # Set X-Content-Security-Policy for older browsers
  Header set X-Content-Security-Policy "default-src 'self'"
  
  # Prevent MIME type sniffing
  Header set X-Content-Type-Options "nosniff"
  
  # Disable browser caching for sensitive pages (adjust as needed)
  <FilesMatch "\.(html|htm|php)$">
    Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
    Header set Pragma "no-cache"
  </FilesMatch>
  
  # Set X-Download-Options for IE8+
  Header set X-Download-Options "noopen"
  
  # Set X-Permitted-Cross-Domain-Policies
  Header set X-Permitted-Cross-Domain-Policies "none"
  
  # Set Expect-CT (Certificate Transparency)
  Header set Expect-CT "max-age=0, report-uri="https://balakarthikeyan.report-uri.com/r/d/ct/reportOnly""
  
  # Set Feature-Policy
  Header set Feature-Policy \
    "geolocation 'none'; \
    midi 'none'; \
    notifications 'none'; \
    push 'none'; \
    sync-xhr 'self'; \
    microphone 'none'; \
    camera 'none'; \
    magnetometer 'none'; \
    gyroscope 'none'; \
    speaker 'self'; \
    vibrate 'none'; \
    fullscreen 'self'; \
    payment 'none'"
</IfModule>

# ============================================
# COMPRESSION
# ============================================
<IfModule mod_deflate.c>
  # Force compression for mangled headers
  <IfModule mod_setenvif.c>
    <IfModule mod_headers.c>
      SetEnvIfNoCase ^(Accept-EncodXng|X-cept-Encoding|X{15}|~{15}|-{15})$ ^((gzip|deflate)\s*,?\s*)+|[X~-]{4,13}$ HAVE_Accept-Encoding
      RequestHeader append Accept-Encoding "gzip,deflate" env=HAVE_Accept-Encoding
    </IfModule>
  </IfModule>

  
  # Compress all output labeled with one of the following MIME-types
  <IfModule mod_filter.c>
    AddOutputFilterByType DEFLATE \
      application/atom+xml \
      application/javascript \
      application/json \
      application/ld+json \
      application/manifest+json \
      application/rdf+xml \
      application/rss+xml \
      application/schema+json \
      application/vnd.geo+json \
      application/vnd.ms-fontobject \
      application/x-font-ttf \
      application/x-javascript \
      application/x-web-app-manifest+json \
      application/xhtml+xml \
      application/xml \
      font/eot \
      font/opentype \
      image/bmp \
      image/svg+xml \
      image/vnd.microsoft.icon \
      image/x-icon \
      text/cache-manifest \
      text/css \
      text/html \
      text/javascript \
      text/plain \
      text/vcard \
      text/vnd.rim.location.xloc \
      text/vtt \
      text/x-component \
      text/x-cross-domain-policy \
      text/xml
      
    # Remove browser bugs (only needed for really old browsers)
    BrowserMatch ^Mozilla/4 gzip-only-text/html
    BrowserMatch ^Mozilla/4\.0[678] no-gzip
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
    Header append Vary User-Agent
  </IfModule>
</IfModule>

# ============================================
# BROWSER CACHING
# ============================================
<IfModule mod_expires.c>
  ExpiresActive On
  
  # Default expiration: 1 hour
  ExpiresDefault "access plus 1 hour"
  
  # HTML: no cache for dynamic content
  ExpiresByType text/html "access plus 0 seconds"
  
  # CSS, JavaScript
  ExpiresByType text/css "access plus 1 year"
  ExpiresByType text/javascript "access plus 1 year"
  ExpiresByType application/javascript "access plus 1 year"
  
  # Media files
  ExpiresByType image/jpg "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/gif "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  
  # Web fonts
  ExpiresByType application/font-woff "access plus 1 year"
  ExpiresByType application/font-woff2 "access plus 1 year"
  ExpiresByType application/vnd.ms-fontobject "access plus 1 year"
  ExpiresByType application/x-font-ttf "access plus 1 year"
  
  # Favicon
  ExpiresByType image/x-icon "access plus 1 week"
</IfModule>

# Disable directory browsing
Options -Indexes

# Custom error pages
ErrorDocument 404 /404.html
ErrorDocument 500 /500.html

# Disable server signature
ServerSignature Off
